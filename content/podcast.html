<script>
function slugify(t){
    return t.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
}

/* ---------- EPISODE MODAL ---------- */
function openEpisodeModal(ep){
    document.getElementById('episodeModalTitle').textContent = ep.title;
    document.getElementById('episodeModalDescription').innerHTML = ep.description;

    const player = document.getElementById('episodePlayer');
    player.src = ep.enclosureUrl;
    player.load();

    const b = document.getElementById('episodeModalButtons');
    b.innerHTML = '';

    const spotify = document.createElement('a');
    spotify.className = 'button spotify';
    spotify.href = ep.listenLink;
    spotify.target = '_blank';
    b.appendChild(spotify);

    const apple = document.createElement('a');
    apple.className = 'button apple';
    apple.href = ep.listenLink.includes('ergopodcast')
        ? 'https://podcasts.apple.com/gb/podcast/ergo-podcast/id1631767451'
        : 'https://podcasts.apple.com/us/podcast/the-sigmacast/id1656621659';
    apple.target = '_blank';
    b.appendChild(apple);

    const dl = document.createElement('a');
    dl.className = 'button';
    dl.textContent = 'Download';
    dl.href = ep.enclosureUrl;
    dl.download = ep.title + '.mp3';
    b.appendChild(dl);

    if(ep.transcriptUrl){
        const t = document.createElement('button');
        t.className = 'button transcript';
        t.textContent = 'Read Transcript';
        t.onclick = () => openTranscript(ep.title, ep.transcriptUrl);
        b.appendChild(t);
    }

    const share = document.createElement('button');
    share.className = 'button transcript';
    share.textContent = 'Share';
    share.onclick = () => {
        const shareUrl = window.location.origin + window.location.pathname + '#' + ep.id;
        navigator.clipboard.writeText(shareUrl);
        share.textContent = 'Copied!';
        setTimeout(() => share.textContent = 'Share', 1200);
    };
    b.appendChild(share);

    document.getElementById('episodeModal').style.display = 'flex';
}

function closeEpisodeModal(){
    document.getElementById('episodeModal').style.display = 'none';
    document.getElementById('episodePlayer').pause();
}

/* ---------- RSS ---------- */
function fetchAndDisplayEpisodes(feed){
    return fetch(feed)
        .then(r => r.text())
        .then(t => {
            const x = new DOMParser().parseFromString(t,'text/xml');
            return [...x.querySelectorAll('item')].map(i => {
                const ns = i.getElementsByTagNameNS(
                    "https://podcastindex.org/namespace/1.0","transcript"
                );
                return {
                    id: 'episode-' + slugify(i.querySelector('title').textContent),
                    title: i.querySelector('title').textContent,
                    description: i.querySelector('description').textContent,
                    listenLink: i.querySelector('link').textContent,
                    enclosureUrl: i.querySelector('enclosure').getAttribute('url'),
                    pubDate: new Date(i.querySelector('pubDate').textContent),
                    transcriptUrl: ns.length ? ns[0].getAttribute('url') : null
                };
            });
        });
}

let allEpisodes = []; // ✅ Make global for hash handling

Promise.all([
    fetchAndDisplayEpisodes('https://anchor.fm/s/f21c6414/podcast/rss'),
    fetchAndDisplayEpisodes('https://anchor.fm/s/d094dce0/podcast/rss')
]).then(([a,b])=>{
    allEpisodes = a.concat(b).sort((x,y)=>y.pubDate - x.pubDate);
    const c = document.getElementById('episodes');

    allEpisodes.forEach(ep=>{
        const d = document.createElement('div');

        const h = document.createElement('h2');
        h.textContent = ep.title;
        h.style.cursor = 'pointer';
        h.onclick = () => openEpisodeModal(ep);

        const desc = document.createElement('div');
        desc.className = 'episode-desc';
        desc.innerHTML = ep.description;

        const more = document.createElement('div');
        more.className = 'read-more';
        more.textContent = 'Read more';
        more.onclick = () => openEpisodeModal(ep);

        const bw = document.createElement('div');

        const s = document.createElement('a');
        s.className = 'button spotify';
        s.href = ep.listenLink;
        s.target = '_blank';
        bw.appendChild(s);

        const aBtn = document.createElement('a');
        aBtn.className = 'button apple';
        aBtn.href = ep.listenLink.includes('ergopodcast')
            ? 'https://podcasts.apple.com/gb/podcast/ergo-podcast/id1631767451'
            : 'https://podcasts.apple.com/us/podcast/the-sigmacast/id1656621659';
        aBtn.target = '_blank';
        bw.appendChild(aBtn);

        const dl = document.createElement('a');
        dl.className = 'button';
        dl.textContent = 'Download';
        dl.href = ep.enclosureUrl;
        dl.download = ep.title + '.mp3';
        bw.appendChild(dl);

        if(ep.transcriptUrl){
            const t = document.createElement('a');
            t.className = 'button transcript';
            t.textContent = 'Read Transcript';
            t.href = 'javascript:void(0)';
            t.onclick = () => openTranscript(ep.title, ep.transcriptUrl);
            bw.appendChild(t);
        }

        d.append(h, desc, more, bw);
        c.appendChild(d);

        requestAnimationFrame(()=>{
            if(desc.scrollHeight > desc.clientHeight){
                more.style.display = 'inline-block';
            }
        });
    });

    // ✅ Open modal if URL has hash
    const hash = location.hash.slice(1);
    if(hash){
        const ep = allEpisodes.find(e => e.id === hash);
        if(ep) openEpisodeModal(ep);
    }
});

/* ---------- TRANSCRIPT ---------- */
function openTranscript(title,url){
    const modal = document.getElementById('transcriptModal');
    const body = document.getElementById('transcriptBody');
    const titleElem = document.getElementById('transcriptTitle');
    const downloadBtn = document.getElementById('downloadTranscriptBtn');

    titleElem.textContent = title;
    body.textContent = 'Loading transcript...';

    const proxied = 'https://api.codetabs.com/v1/proxy/?quest=' + encodeURIComponent(url);
    downloadBtn.href = proxied;
    downloadBtn.download = title + '.srt';

    modal.style.display = 'flex';

    fetch(proxied)
        .then(res => res.text())
        .then(txt => body.textContent = txt);
}

function closeTranscript(){
    document.getElementById('transcriptModal').style.display = 'none';
}
</script>
